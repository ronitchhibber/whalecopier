<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whale Tracker Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #e4e4e7;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-left p {
            opacity: 0.9;
        }

        .header-right {
            text-align: right;
        }

        .clock {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .timezone {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .toggle-label {
            font-size: 0.95rem;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4a5568;
            transition: .3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #48bb78;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Table Wrapper */
        .table-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            height: auto;
            background: #1a1e3a;
            border-radius: 8px;
        }

        /* Scrollable Table Container */
        .table-container {
            max-height: 550px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 8px 8px 0 0;
        }

        .table-container::-webkit-scrollbar {
            width: 10px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #1a1e3a;
            border-radius: 8px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 8px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: #1a1e3a;
        }

        .stat-card {
            background: #252a4a;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #9ca3af;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .tabs {
            display: flex;
            background: #1a1e3a;
            padding: 0 1.5rem;
            gap: 0.5rem;
        }

        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #e4e4e7;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .content {
            padding: 2rem 1.5rem;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #252a4a;
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: #1a1e3a;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #667eea;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #1a1e3a;
        }

        tr:hover {
            background: #2d3250;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-mega {
            background: #7c3aed;
            color: white;
        }

        .badge-high {
            background: #2563eb;
            color: white;
        }

        .badge-medium {
            background: #059669;
            color: white;
        }

        .badge-buy {
            background: #10b981;
            color: white;
        }

        .badge-sell {
            background: #ef4444;
            color: white;
        }

        .link {
            color: #667eea;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .paper-trading-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #252a4a;
            border-radius: 8px;
        }

        .balance-display {
            font-size: 2rem;
            font-weight: bold;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #252a4a;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #9ca3af;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #e4e4e7;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid #252a4a;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            flex: 1;
        }

        .mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: #1a1e3a;
            padding: 0.5rem;
            border-radius: 8px;
            width: fit-content;
        }

        .mode-toggle button {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: #9ca3af;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-toggle button.active {
            background: #667eea;
            color: white;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #1a1e3a;
            border-top: 1px solid #252a4a;
            border-radius: 0 0 8px 8px;
        }

        .pagination button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            background: #667eea;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .pagination button:disabled {
            background: #4a5568;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pagination span {
            color: #e4e4e7;
            font-weight: 600;
            min-width: 100px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>WhaleTracker</h1>
            <p>Real-time monitoring and copy trading for Polymarket whales</p>
        </div>
        <div class="header-right">
            <div class="toggle-container">
                <span class="toggle-label">Live Trading</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="live-trading-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="clock" id="live-clock">--:--:-- PM</div>
            <div class="timezone">Pacific Time (PST)</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('whales')">Whales</button>
        <button class="tab" onclick="switchTab('trades')">Live Trades</button>
        <button class="tab" onclick="switchTab('trading')">Trading</button>
        <button class="tab" onclick="switchTab('backtest')">Backtest</button>
        <button class="tab" onclick="switchTab('methodology')">Methodology</button>
        <button class="tab" onclick="switchTab('settings')">Settings</button>
    </div>

    <div class="content">
        <!-- Whales Tab -->
        <div id="whales-panel" class="tab-panel active">
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-value" id="total-whales">--</div>
                    <div class="stat-label">Active Whales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="trades-24h">--</div>
                    <div class="stat-label">Trades (24h)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="volume-24h">$--</div>
                    <div class="stat-label">Volume (24h)</div>
                </div>
            </div>
            <div class="loading" id="whales-loading">
                <div class="spinner"></div>
                <p>Loading whales...</p>
            </div>
            <div class="table-wrapper">
                <div class="table-container">
                    <table id="whales-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Whale</th>
                                <th>Tier</th>
                                <th>Quality Score</th>
                                <th>Win Rate</th>
                                <th>Sharpe</th>
                                <th>Total Volume</th>
                                <th>Total P&L</th>
                                <th>Trades</th>
                                <th>Profile</th>
                            </tr>
                        </thead>
                        <tbody id="whales-tbody"></tbody>
                    </table>
                </div>
                <div class="pagination" id="whales-pagination" style="display: none;">
                    <button onclick="changePage('whales', -1)" id="whales-prev">Previous</button>
                    <span id="whales-page-info">Page 1</span>
                    <button onclick="changePage('whales', 1)" id="whales-next">Next</button>
                </div>
            </div>
        </div>

        <!-- Trades Tab -->
        <div id="trades-panel" class="tab-panel">
            <div class="loading" id="trades-loading">
                <div class="spinner"></div>
                <p>Loading trades...</p>
            </div>
            <div class="table-wrapper">
                <div class="table-container">
                    <table id="trades-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Whale</th>
                                <th>Market / Bet</th>
                                <th>Side</th>
                                <th>Size</th>
                                <th>Price</th>
                                <th>Amount</th>
                                <th>Copied</th>
                            </tr>
                        </thead>
                        <tbody id="trades-tbody"></tbody>
                    </table>
                </div>
                <div class="pagination" id="trades-pagination" style="display: none;">
                    <button onclick="changePage('trades', -1)" id="trades-prev">Previous</button>
                    <span id="trades-page-info">Page 1</span>
                    <button onclick="changePage('trades', 1)" id="trades-next">Next</button>
                </div>
            </div>
        </div>

        <!-- Trading Tab -->
        <div id="trading-panel" class="tab-panel">
            <div class="mode-toggle">
                <button class="active" onclick="switchTradingMode('paper')">Paper Trading</button>
                <button onclick="switchTradingMode('live')">Live Trading</button>
            </div>

            <div class="paper-trading-header">
                <div>
                    <div class="stat-label">Current Balance</div>
                    <div class="balance-display" id="trading-balance">$10,000.00</div>
                </div>
                <div>
                    <div class="stat-label">Total P&L</div>
                    <div class="balance-display" id="trading-pnl">$0.00</div>
                </div>
                <div>
                    <div class="stat-label">Win Rate</div>
                    <div class="balance-display" id="trading-winrate">0%</div>
                </div>
                <div>
                    <div class="stat-label">ROI</div>
                    <div class="balance-display" id="trading-roi">0%</div>
                </div>
            </div>

            <!-- Active Bets Section -->
            <h3 style="margin: 2rem 0 1rem 0; color: #667eea;">Active Bets</h3>
            <table id="active-bets-table">
                <thead>
                    <tr>
                        <th>Market</th>
                        <th>Side</th>
                        <th>Entry Price</th>
                        <th>Current Price</th>
                        <th>Size</th>
                        <th>Amount</th>
                        <th>Unrealized P&L</th>
                        <th>ROI</th>
                        <th>Time Held</th>
                    </tr>
                </thead>
                <tbody id="active-bets-tbody">
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 2rem; color: #9ca3af;">No active bets</td>
                    </tr>
                </tbody>
            </table>

            <!-- Trade History Section -->
            <h3 style="margin: 2rem 0 1rem 0; color: #667eea;">Trade History</h3>
            <div class="loading" id="trading-loading">
                <div class="spinner"></div>
                <p>Loading trades...</p>
            </div>
            <table id="trading-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Whale</th>
                        <th>Market</th>
                        <th>Side</th>
                        <th>Size</th>
                        <th>Price</th>
                        <th>Amount</th>
                        <th>Quality Score</th>
                        <th>Sizing Factor</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="trading-tbody"></tbody>
            </table>
            <div id="trading-empty" class="empty-state" style="display: none;">
                <h3>No trades yet</h3>
                <p>Trades will appear here automatically when whales make trades</p>
            </div>
        </div>

        <!-- Backtest Tab -->
        <div id="backtest-panel" class="tab-panel">
            <div style="max-width: 1200px; margin: 0 auto;">
                <h2 style="margin-bottom: 2rem; color: #667eea;">Strategy Backtesting</h2>

                <!-- Backtest Configuration -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 style="color: #667eea; margin-bottom: 1.5rem;">Backtest Parameters</h3>

                    <form id="backtestForm" onsubmit="runBacktest(event)">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #8b9dc3;">Starting Balance ($)</label>
                                <input type="number" id="bt_balance" value="1000" step="100" min="100" style="width: 100%; padding: 0.75rem; background: #1a1d35; border: 1px solid #2d3352; border-radius: 6px; color: #fff;">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #8b9dc3;">Max Position Size ($)</label>
                                <input type="number" id="bt_max_position" value="100" step="10" min="10" style="width: 100%; padding: 0.75rem; background: #1a1d35; border: 1px solid #2d3352; border-radius: 6px; color: #fff;">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #8b9dc3;">Min Whale Quality</label>
                                <input type="number" id="bt_min_quality" value="50" min="0" max="100" style="width: 100%; padding: 0.75rem; background: #1a1d35; border: 1px solid #2d3352; border-radius: 6px; color: #fff;">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #8b9dc3;">Days to Test</label>
                                <input type="number" id="bt_days_back" value="30" min="1" max="365" style="width: 100%; padding: 0.75rem; background: #1a1d35; border: 1px solid #2d3352; border-radius: 6px; color: #fff;">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #8b9dc3;">Position Size (%)</label>
                                <input type="number" id="bt_position_pct" value="5" min="1" max="20" step="1" style="width: 100%; padding: 0.75rem; background: #1a1d35; border: 1px solid #2d3352; border-radius: 6px; color: #fff;">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #8b9dc3;">Max Daily Loss ($)</label>
                                <input type="number" id="bt_max_daily_loss" value="500" step="50" min="50" style="width: 100%; padding: 0.75rem; background: #1a1d35; border: 1px solid #2d3352; border-radius: 6px; color: #fff;">
                            </div>
                        </div>

                        <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 1rem;">
                            Run Backtest
                        </button>
                    </form>
                </div>

                <!-- Backtest Results -->
                <div id="backtestResults" style="display: none;">
                    <!-- Performance Summary -->
                    <div class="stats-bar" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-label">Starting Balance</div>
                            <div class="stat-value" id="bt_start_balance">$0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Ending Balance</div>
                            <div class="stat-value" id="bt_end_balance">$0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total P&L</div>
                            <div class="stat-value" id="bt_total_pnl">$0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-value" id="bt_win_rate">0%</div>
                        </div>
                    </div>

                    <!-- Disclaimer Box -->
                    <div style="background: linear-gradient(135deg, #ff6b6b22 0%, #ffd93d22 100%); border: 2px solid #ff6b6b; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="font-size: 2rem; flex-shrink: 0;">‚ö†Ô∏è</div>
                            <div>
                                <h3 style="color: #ff6b6b; margin: 0 0 0.75rem 0; font-size: 1.1rem;">Backtest Limitations</h3>
                                <div style="color: #ddd; font-size: 0.9rem; line-height: 1.6;">
                                    <p style="margin: 0 0 0.5rem 0;"><strong>This backtest uses estimated performance:</strong></p>
                                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                        <li>Win rates are <strong>discounted 20%</strong> to account for regression to the mean and execution challenges</li>
                                        <li>Includes 2% trading fees on all positions</li>
                                        <li>Timestamps are synthetic (spread over 60 days) for visualization purposes</li>
                                        <li>Does not account for slippage, liquidity constraints, or market impact from copying</li>
                                        <li>Past performance does not guarantee future results</li>
                                    </ul>
                                    <p style="margin: 0.75rem 0 0 0; font-style: italic; color: #ffd93d;">
                                        Use these results to compare <em>relative</em> strategy performance and test risk parameters, not as a prediction of actual returns.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; margin-bottom: 2rem;">
                        <div class="card">
                            <h3 style="color: #667eea; margin-bottom: 1rem;">Trade Statistics</h3>
                            <div style="display: grid; gap: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #1a1d35; border-radius: 6px;">
                                    <span style="color: #8b9dc3;">Total Trades:</span>
                                    <span style="color: #fff; font-weight: bold;" id="bt_total_trades">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #1a1d35; border-radius: 6px;">
                                    <span style="color: #8b9dc3;">Winning Trades:</span>
                                    <span style="color: #10b981; font-weight: bold;" id="bt_winning_trades">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #1a1d35; border-radius: 6px;">
                                    <span style="color: #8b9dc3;">Losing Trades:</span>
                                    <span style="color: #ef4444; font-weight: bold;" id="bt_losing_trades">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 style="color: #667eea; margin-bottom: 1rem;">Risk Metrics</h3>
                            <div style="display: grid; gap: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #1a1d35; border-radius: 6px;">
                                    <span style="color: #8b9dc3;">Max Drawdown:</span>
                                    <span style="color: #fff; font-weight: bold;" id="bt_max_drawdown">$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #1a1d35; border-radius: 6px;">
                                    <span style="color: #8b9dc3;">Sharpe Ratio:</span>
                                    <span style="color: #fff; font-weight: bold;" id="bt_sharpe">0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #1a1d35; border-radius: 6px;">
                                    <span style="color: #8b9dc3;">Test Period:</span>
                                    <span style="color: #fff; font-weight: bold;" id="bt_period">0 days</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- All Trades -->
                    <div class="card">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">All Backtest Trades</h3>
                        <div id="bt_all_trades"></div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="backtestLoading" style="display: none; padding: 3rem;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="color: #667eea; font-size: 1.2rem; margin-bottom: 0.5rem;">Running Backtest</div>
                        <div id="backtestProgressText" style="color: #8b9dc3; margin-bottom: 2rem;">Initializing...</div>
                    </div>

                    <!-- Progress Bar -->
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="background: #1a1d35; border-radius: 12px; height: 24px; overflow: hidden; border: 1px solid #2d3352;">
                            <div id="backtestProgressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                                <span id="backtestProgressPercent" style="color: white; font-size: 0.75rem; font-weight: bold;"></span>
                            </div>
                        </div>

                        <!-- Step Details -->
                        <div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; font-size: 0.85rem;">
                            <div id="step1" style="text-align: center; color: #4a5568; transition: color 0.3s;">
                                <div style="margin-bottom: 0.25rem;">üìä</div>
                                <div>Load Data</div>
                            </div>
                            <div id="step2" style="text-align: center; color: #4a5568; transition: color 0.3s;">
                                <div style="margin-bottom: 0.25rem;">üéØ</div>
                                <div>Filter Trades</div>
                            </div>
                            <div id="step3" style="text-align: center; color: #4a5568; transition: color 0.3s;">
                                <div style="margin-bottom: 0.25rem;">üî¨</div>
                                <div>Calculate P&L</div>
                            </div>
                            <div id="step4" style="text-align: center; color: #4a5568; transition: color 0.3s;">
                                <div style="margin-bottom: 0.25rem;">üìà</div>
                                <div>Generate Results</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Methodology Tab -->
        <div id="methodology-panel" class="tab-panel">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2 style="margin-bottom: 2rem; color: #667eea;">System Methodology</h2>

                <div style="background: #252a4a; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h3 style="color: #667eea; margin-bottom: 1rem;">Whale Quality Score Calculation</h3>
                    <p style="margin-bottom: 1rem;">Every whale is assigned a quality score from 0-100 that determines their copy trading eligibility and position sizing. The score is a weighted combination of multiple performance metrics:</p>

                    <div style="background: #1a1e3a; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                        <h4 style="color: #10b981; margin-bottom: 1rem;">üìä Score Components & Weights</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #667eea;">
                                    <th style="text-align: left; padding: 0.5rem;">Metric</th>
                                    <th style="text-align: center; padding: 0.5rem;">Weight</th>
                                    <th style="text-align: center; padding: 0.5rem;">Target</th>
                                    <th style="text-align: center; padding: 0.5rem;">Max Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 0.5rem;"><strong>Win Rate</strong></td>
                                    <td style="text-align: center; padding: 0.5rem;">25%</td>
                                    <td style="text-align: center; padding: 0.5rem;">‚â•60%</td>
                                    <td style="text-align: center; padding: 0.5rem;">25 points</td>
                                </tr>
                                <tr style="background: rgba(102, 126, 234, 0.1);">
                                    <td style="padding: 0.5rem;"><strong>Total PnL</strong></td>
                                    <td style="text-align: center; padding: 0.5rem;">20%</td>
                                    <td style="text-align: center; padding: 0.5rem;">‚â•$10,000</td>
                                    <td style="text-align: center; padding: 0.5rem;">20 points</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem;"><strong>Sharpe Ratio</strong></td>
                                    <td style="text-align: center; padding: 0.5rem;">20%</td>
                                    <td style="text-align: center; padding: 0.5rem;">‚â•2.0</td>
                                    <td style="text-align: center; padding: 0.5rem;">20 points</td>
                                </tr>
                                <tr style="background: rgba(102, 126, 234, 0.1);">
                                    <td style="padding: 0.5rem;"><strong>Total Volume</strong></td>
                                    <td style="text-align: center; padding: 0.5rem;">15%</td>
                                    <td style="text-align: center; padding: 0.5rem;">‚â•$100,000</td>
                                    <td style="text-align: center; padding: 0.5rem;">15 points</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem;"><strong>Trade Count</strong></td>
                                    <td style="text-align: center; padding: 0.5rem;">10%</td>
                                    <td style="text-align: center; padding: 0.5rem;">‚â•100</td>
                                    <td style="text-align: center; padding: 0.5rem;">10 points</td>
                                </tr>
                                <tr style="background: rgba(102, 126, 234, 0.1);">
                                    <td style="padding: 0.5rem;"><strong>Avg Trade Size</strong></td>
                                    <td style="text-align: center; padding: 0.5rem;">5%</td>
                                    <td style="text-align: center; padding: 0.5rem;">‚â•$1,000</td>
                                    <td style="text-align: center; padding: 0.5rem;">5 points</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem;"><strong>Recency Bonus</strong></td>
                                    <td style="text-align: center; padding: 0.5rem;">5%</td>
                                    <td style="text-align: center; padding: 0.5rem;">Active in 24h</td>
                                    <td style="text-align: center; padding: 0.5rem;">5 points</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="background: #1a1e3a; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                        <h4 style="color: #10b981; margin-bottom: 1rem;">üßÆ Calculation Formula</h4>
                        <pre style="background: #0a0e27; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.875rem; color: #10b981;">
Quality Score = Œ£(Component Score √ó Weight)

Where each component score is calculated as:
Component Score = min(100, (Actual Value / Target Value) √ó 100)

Example for a whale with:
‚Ä¢ Win Rate: 65% ‚Üí Score: min(100, 65/60 √ó 100) = 100 ‚Üí 25 points
‚Ä¢ Total PnL: $5,000 ‚Üí Score: min(100, 5000/10000 √ó 100) = 50 ‚Üí 10 points
‚Ä¢ Sharpe Ratio: 1.5 ‚Üí Score: min(100, 1.5/2.0 √ó 100) = 75 ‚Üí 15 points
‚Ä¢ Total Volume: $150,000 ‚Üí Score: min(100, 150000/100000 √ó 100) = 100 ‚Üí 15 points
‚Ä¢ Trade Count: 80 ‚Üí Score: min(100, 80/100 √ó 100) = 80 ‚Üí 8 points
‚Ä¢ Avg Trade Size: $1,875 ‚Üí Score: min(100, 1875/1000 √ó 100) = 100 ‚Üí 5 points
‚Ä¢ Last Trade: 12 hours ago ‚Üí Recency bonus ‚Üí 5 points

Total Quality Score = 83/100 (MEGA Tier)</pre>
                    </div>

                    <div style="background: #1a1e3a; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                        <h4 style="color: #10b981; margin-bottom: 1rem;">üèÜ Quality Tiers</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 0.5rem;"><span class="badge badge-mega">MEGA</span></td>
                                <td style="padding: 0.5rem;">80-100 points</td>
                                <td style="padding: 0.5rem; color: #10b981;">Elite performers, maximum position sizing</td>
                            </tr>
                            <tr style="background: rgba(102, 126, 234, 0.1);">
                                <td style="padding: 0.5rem;"><span class="badge badge-high">HIGH</span></td>
                                <td style="padding: 0.5rem;">60-79 points</td>
                                <td style="padding: 0.5rem; color: #667eea;">Strong performers, increased position sizing</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem;"><span class="badge badge-medium">MEDIUM</span></td>
                                <td style="padding: 0.5rem;">40-59 points</td>
                                <td style="padding: 0.5rem; color: #9ca3af;">Solid performers, standard position sizing</td>
                            </tr>
                            <tr style="background: rgba(102, 126, 234, 0.1);">
                                <td style="padding: 0.5rem;"><span style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">LOW</span></td>
                                <td style="padding: 0.5rem;">30-39 points</td>
                                <td style="padding: 0.5rem; color: #ef4444;">Minimum viable, reduced position sizing</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem;"><span style="background: #4a5568; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">EXCLUDED</span></td>
                                <td style="padding: 0.5rem;">&lt;30 points</td>
                                <td style="padding: 0.5rem; color: #4a5568;">Not eligible for copy trading</td>
                            </tr>
                        </table>
                    </div>

                    <div style="background: #1a1e3a; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                        <h4 style="color: #10b981; margin-bottom: 1rem;">‚ö° Special Adjustments</h4>
                        <ul style="margin-left: 1.5rem; line-height: 1.8;">
                            <li><strong>Consistency Bonus (+5):</strong> If standard deviation of returns &lt; 10%</li>
                            <li><strong>High Volume Bonus (+5):</strong> If total volume &gt; $500,000</li>
                            <li><strong>Drawdown Penalty (-10):</strong> If max drawdown &gt; 30%</li>
                            <li><strong>Inactivity Penalty (-20):</strong> If no trades in last 7 days</li>
                            <li><strong>Low Trade Count Penalty (-15):</strong> If less than 10 total trades</li>
                        </ul>
                    </div>

                    <p style="margin-top: 1.5rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; border-radius: 4px;">
                        <strong>üí° Key Insight:</strong> The quality score is recalculated every 6 hours using the latest performance data. Whales with scores ‚â•30 are eligible for copy trading, with position sizes scaled proportionally to their quality score. This ensures capital is allocated to the most consistent and profitable traders.
                    </p>
                </div>

                <div style="background: #252a4a; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h3 style="color: #667eea; margin-bottom: 1rem;">Monitoring System</h3>
                    <p style="margin-bottom: 1rem;">Two-tier monitoring system:</p>
                    <ul style="margin-left: 2rem; line-height: 2;">
                        <li><strong>Trade Monitor (every 15 min):</strong> Detects new whale trades in real-time by monitoring profile changes</li>
                        <li><strong>Metrics Updater (every 6 hours):</strong> Updates comprehensive 24-hour metrics, volume, and activity data</li>
                    </ul>
                    <p style="margin-top: 1rem; color: #9ca3af;">
                        System checks whales 96 times per day for trade activity, ensuring minimal latency in detecting new positions.
                    </p>
                </div>

                <div style="background: #252a4a; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h3 style="color: #667eea; margin-bottom: 1rem;">Position Sizing</h3>
                    <p style="margin-bottom: 1rem;">Dynamic position sizing based on whale quality:</p>
                    <pre style="background: #1a1e3a; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.875rem;">
Position Size = Base % √ó Quality Factor √ó Trade Size Ratio √ó Available Balance

Where:
‚Ä¢ Base % = 5% (configurable)
‚Ä¢ Quality Factor = Whale Quality Score / 100
‚Ä¢ Trade Size Ratio = min(Trade Size / Whale Avg, 2.0)
‚Ä¢ Max Position = 10% of balance</pre>
                    <p style="margin-top: 1rem; color: #9ca3af;">
                        Higher quality whales get larger position allocations. Unusually large trades (relative to whale's history) receive increased sizing.
                    </p>
                </div>

                <div style="background: #252a4a; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h3 style="color: #667eea; margin-bottom: 1rem;">Risk Management</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #1a1e3a;"><strong>Stop-Loss</strong></td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #1a1e3a;">15% per position</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #1a1e3a;"><strong>Take-Profit</strong></td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #1a1e3a;">30% per position</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #1a1e3a;"><strong>Max Daily Loss</strong></td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #1a1e3a;">$500 (circuit breaker)</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #1a1e3a;"><strong>Max Position Size</strong></td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #1a1e3a;">10% of balance</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;"><strong>Min Quality Score</strong></td>
                            <td style="padding: 0.5rem;">30/100 to enable copying</td>
                        </tr>
                    </table>
                </div>

                <div style="background: #252a4a; padding: 2rem; border-radius: 8px;">
                    <h3 style="color: #667eea; margin-bottom: 1rem;">Quality Thresholds</h3>
                    <table style="width: 100%;">
                        <tr>
                            <td style="padding: 0.5rem;"><strong>Minimum PnL</strong></td>
                            <td style="padding: 0.5rem; text-align: right;">$1,000</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;"><strong>Minimum Trades</strong></td>
                            <td style="padding: 0.5rem; text-align: right;">10 trades</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;"><strong>Activity Requirement</strong></td>
                            <td style="padding: 0.5rem; text-align: right;">Last 30 days</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;"><strong>Profile Availability</strong></td>
                            <td style="padding: 0.5rem; text-align: right;">Public Polymarket profile required</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-panel" class="tab-panel">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2 style="margin-bottom: 2rem; color: #667eea;">Trading Settings</h2>

                <form id="settings-form">
                    <!-- Paper Trading Settings -->
                    <div style="background: #252a4a; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1.5rem;">Paper Trading</h3>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Initial Balance ($)</label>
                            <input type="number" id="initial_balance" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="10000">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Base Position Size (%)</label>
                            <input type="number" step="0.1" id="base_position_size_pct" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="5.0">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Max Position Size (%)</label>
                            <input type="number" step="0.1" id="max_position_size_pct" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="10.0">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Kelly Fraction</label>
                            <input type="number" step="0.05" id="kelly_fraction" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="0.25">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Min Quality Score to Copy</label>
                            <input type="number" step="1" id="min_quality_score" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="50">
                        </div>
                    </div>

                    <!-- Whale Filters -->
                    <div style="background: #252a4a; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1.5rem;">Whale Filters</h3>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Min Win Rate (%)</label>
                            <input type="number" step="1" id="min_win_rate" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="55">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Min Sharpe Ratio</label>
                            <input type="number" step="0.1" id="min_sharpe" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="1.0">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Min Total Volume ($)</label>
                            <input type="number" step="1000" id="min_total_volume" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="50000">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #9ca3af;">
                                <input type="checkbox" id="copy_only_mega_high" style="width: 20px; height: 20px;">
                                Copy Only MEGA/HIGH Tier Whales
                            </label>
                        </div>
                    </div>

                    <!-- Risk Management -->
                    <div style="background: #252a4a; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1.5rem;">Risk Management</h3>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Stop-Loss (%)</label>
                            <input type="number" step="1" id="stop_loss_pct" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="15">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Take-Profit (%)</label>
                            <input type="number" step="1" id="take_profit_pct" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="30">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Max Daily Loss ($)</label>
                            <input type="number" step="10" id="max_daily_loss" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="500">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #9ca3af;">Circuit Breaker Loss (%)</label>
                            <input type="number" step="1" id="circuit_breaker_loss_pct" style="width: 100%; padding: 0.75rem; background: #1a1e3a; border: 1px solid #667eea; border-radius: 4px; color: #e4e4e7;" value="5">
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" style="flex: 1; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 1rem;">
                            Save Settings
                        </button>
                        <button type="button" onclick="resetSettings()" style="padding: 1rem 2rem; background: #252a4a; border: 1px solid #667eea; border-radius: 8px; color: #667eea; font-weight: bold; cursor: pointer; font-size: 1rem;">
                            Reset to Defaults
                        </button>
                    </div>
                </form>

                <div id="settings-message" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentTradingMode = 'paper'; // 'paper' or 'live'

        // Pagination state
        const ITEMS_PER_PAGE = 25;
        const paginationState = {
            whales: { currentPage: 1, data: [] },
            trades: { currentPage: 1, data: [] }
        };

        // Render paginated data
        function renderPage(tableName) {
            const state = paginationState[tableName];
            const start = (state.currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = state.data.slice(start, end);
            const totalPages = Math.ceil(state.data.length / ITEMS_PER_PAGE);

            // Render the data
            if (tableName === 'whales') {
                renderWhalePage(pageData);
            } else if (tableName === 'trades') {
                renderTradesPage(pageData);
            }

            // Update pagination controls
            updatePaginationControls(tableName, state.currentPage, totalPages);
        }

        // Change page
        function changePage(tableName, direction) {
            const state = paginationState[tableName];
            const totalPages = Math.ceil(state.data.length / ITEMS_PER_PAGE);
            const newPage = state.currentPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                state.currentPage = newPage;
                renderPage(tableName);
            }
        }

        // Update pagination controls
        function updatePaginationControls(tableName, currentPage, totalPages) {
            const pagination = document.getElementById(`${tableName}-pagination`);
            const prevBtn = document.getElementById(`${tableName}-prev`);
            const nextBtn = document.getElementById(`${tableName}-next`);
            const pageInfo = document.getElementById(`${tableName}-page-info`);

            if (totalPages > 1) {
                pagination.style.display = 'flex';
                prevBtn.disabled = (currentPage === 1);
                nextBtn.disabled = (currentPage === totalPages);
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            } else {
                pagination.style.display = 'none';
            }
        }

        // Trading mode switching
        async function switchTradingMode(mode) {
            try {
                // Call API to set trading mode
                const response = await fetch('/api/trading/mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mode: mode })
                });

                const result = await response.json();

                if (result.success) {
                    currentTradingMode = mode;

                    // Update button states
                    const buttons = document.querySelectorAll('.mode-toggle button');
                    buttons.forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent.toLowerCase().includes(mode)) {
                            btn.classList.add('active');
                        }
                    });

                    // Show confirmation message
                    if (mode === 'live') {
                        alert('LIVE TRADING ENABLED\n\nCAUTION: Real money will be used!\n\nSafety limits:\n- Max $100 per trade\n- $500 daily loss limit\n- Min whale quality: 50');
                    } else {
                        alert('Paper trading mode enabled\n\nNo real money will be used.');
                    }

                    // Reload trading data
                    loadTradingData();
                } else {
                    alert('Failed to change trading mode: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error switching trading mode:', error);
                alert('Error changing trading mode. Check console for details.');
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`${tabName}-panel`).classList.add('active');

            // Load data for the tab
            if (tabName === 'whales') {
                loadWhales();
            } else if (tabName === 'trades') {
                loadTrades();
            } else if (tabName === 'trading') {
                loadTradingData();
            } else if (tabName === 'settings') {
                loadSettings();
            }
            // methodology tab is static, no loading needed
        }

        // Update clock in PST
        function updateClock() {
            const now = new Date();
            const pstTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
            const hours = pstTime.getHours();
            const minutes = pstTime.getMinutes().toString().padStart(2, '0');
            const seconds = pstTime.getSeconds().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;

            const clockElement = document.getElementById('live-clock');
            if (clockElement) {
                clockElement.textContent = `${displayHours}:${minutes}:${seconds} ${ampm}`;
            }
        }

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format percentage
        function formatPercent(value) {
            return `${value.toFixed(1)}%`;
        }

        // Format date in PST
        function formatDate(dateString) {
            if (!dateString) return '--';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                timeZone: 'America/Los_Angeles',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            }) + ' PST';
        }

        // Format time ago - shows relative time or full date
        function timeAgo(dateString) {
            if (!dateString) return '--';

            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            // If less than 1 minute ago
            if (diffSec < 60) {
                return 'Just now';
            }
            // If less than 1 hour ago
            else if (diffMin < 60) {
                return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
            }
            // If less than 24 hours ago
            else if (diffHour < 24) {
                return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
            }
            // If less than 7 days ago
            else if (diffDay < 7) {
                return `${diffDay} day${diffDay !== 1 ? 's' : ''} ago`;
            }
            // Otherwise show full date in PST
            else {
                return date.toLocaleString('en-US', {
                    timeZone: 'America/Los_Angeles',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                }) + ' PST';
            }
        }

        // Load summary stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats/summary');
                const data = await response.json();

                document.getElementById('total-whales').textContent = data.total_whales;
                document.getElementById('trades-24h').textContent = data.trades_24h;
                document.getElementById('volume-24h').textContent = formatCurrency(data.volume_24h);
                document.getElementById('paper-balance').textContent = formatCurrency(data.paper_balance);
                document.getElementById('paper-pnl').textContent = formatCurrency(data.paper_pnl);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Render whale page
        function renderWhalePage(whales) {
            const tbody = document.getElementById('whales-tbody');
            tbody.innerHTML = '';

            if (whales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #9ca3af;">No whales on this page.</td></tr>';
            } else {
                whales.forEach(whale => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${whale.pseudonym || 'Unknown'}</strong><br><small style="color: #9ca3af;">${whale.address.substring(0, 10)}...</small></td>
                        <td><span class="badge badge-${whale.tier.toLowerCase()}">${whale.tier}</span></td>
                        <td><strong>${whale.quality_score.toFixed(1)}</strong></td>
                        <td><span class="positive">${formatPercent(whale.win_rate)}</span></td>
                        <td>${whale.sharpe_ratio.toFixed(2)}</td>
                        <td>${formatCurrency(whale.total_volume)}</td>
                        <td class="${whale.total_pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(whale.total_pnl)}</td>
                        <td>${whale.total_trades}</td>
                        <td><a href="${whale.profile_url}" target="_blank" class="link">View Profile</a></td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // Load whales
        async function loadWhales() {
            try {
                const response = await fetch('/api/whales');
                const whales = await response.json();

                if (whales.length === 0) {
                    document.getElementById('whales-tbody').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #9ca3af;">No whales found. Run scripts/seed_whales.py to add whales.</td></tr>';
                } else {
                    // Store data and render first page
                    paginationState.whales.data = whales;
                    paginationState.whales.currentPage = 1;
                    renderPage('whales');
                }

                document.getElementById('whales-loading').style.display = 'none';
                document.getElementById('whales-table').style.display = 'table';
            } catch (error) {
                console.error('Error loading whales:', error);
            }
        }

        // Render trades page
        function renderTradesPage(trades) {
            const tbody = document.getElementById('trades-tbody');
            tbody.innerHTML = '';

            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #9ca3af;">No trades on this page.</td></tr>';
            } else {
                trades.forEach(trade => {
                    const row = document.createElement('tr');

                    // Display market title if available, otherwise show truncated market_id
                    let marketDisplay = '--';
                    if (trade.market_title) {
                        // Truncate long market titles
                        marketDisplay = trade.market_title.length > 60
                            ? trade.market_title.substring(0, 60) + '...'
                            : trade.market_title;
                    } else if (trade.market_id && trade.market_id !== '' && trade.market_id !== 'None') {
                        marketDisplay = `<small style="color: #9ca3af;">${trade.market_id.substring(0, 20)}...</small>`;
                    }

                    row.innerHTML = `
                        <td>${timeAgo(trade.timestamp)}</td>
                        <td><strong>${trade.whale_name || trade.trader_address.substring(0, 10) + '...'}</strong></td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="${trade.market_title || trade.market_id || 'Unknown market'}">${marketDisplay}</td>
                        <td><span class="badge badge-${trade.side.toLowerCase()}">${trade.side}</span></td>
                        <td>${trade.size.toFixed(0)}</td>
                        <td>$${trade.price.toFixed(3)}</td>
                        <td>${formatCurrency(trade.amount)}</td>
                        <td>${trade.followed ? 'YES' : 'PENDING'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // Load trades
        async function loadTrades() {
            try {
                const response = await fetch('/api/trades?limit=500');
                const trades = await response.json();

                if (trades.length === 0) {
                    document.getElementById('trades-tbody').innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #9ca3af;">No trades yet. Trades will appear here when whales make them.</td></tr>';
                } else {
                    // Store data and render first page
                    paginationState.trades.data = trades;
                    paginationState.trades.currentPage = 1;
                    renderPage('trades');
                }

                document.getElementById('trades-loading').style.display = 'none';
                document.getElementById('trades-table').style.display = 'table';
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }

        // Load trading data (paper or live)
        async function loadTradingData() {
            try {
                const [portfolioResponse, performanceResponse] = await Promise.all([
                    fetch('/api/paper-trading/portfolio'),
                    fetch('/api/paper-trading/performance')
                ]);

                const portfolio = await portfolioResponse.json();
                const performance = await performanceResponse.json();

                // Update header stats
                document.getElementById('trading-balance').textContent = formatCurrency(portfolio.balance);
                document.getElementById('trading-pnl').textContent = formatCurrency(performance.total_pnl);
                document.getElementById('trading-winrate').textContent = formatPercent(performance.win_rate);
                document.getElementById('trading-roi').textContent = formatPercent(performance.roi);

                // Update color based on P&L
                const pnlElement = document.getElementById('trading-pnl');
                pnlElement.className = `balance-display ${performance.total_pnl >= 0 ? 'positive' : 'negative'}`;

                // Load active bets (currently from positions in portfolio)
                loadActiveBets(portfolio.positions);

                // Load trade history
                const tbody = document.getElementById('trading-tbody');
                tbody.innerHTML = '';

                if (portfolio.trades.length === 0) {
                    document.getElementById('trading-loading').style.display = 'none';
                    document.getElementById('trading-empty').style.display = 'block';
                    document.getElementById('trading-table').style.display = 'none';
                } else {
                    portfolio.trades.forEach(trade => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(trade.timestamp)}</td>
                            <td><strong>${trade.whale_name}</strong><br><small>${trade.whale_address.substring(0, 10)}...</small></td>
                            <td><small>${trade.market_id ? trade.market_id.substring(0, 15) + '...' : '--'}</small></td>
                            <td><span class="badge badge-${trade.side.toLowerCase()}">${trade.side}</span></td>
                            <td>${trade.size.toFixed(2)}</td>
                            <td>$${trade.price.toFixed(3)}</td>
                            <td>${formatCurrency(trade.amount)}</td>
                            <td>${trade.quality_score.toFixed(1)}</td>
                            <td>${(trade.sizing_factor * 100).toFixed(1)}%</td>
                            <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(trade.pnl)}</td>
                        `;
                        tbody.appendChild(row);
                    });

                    document.getElementById('trading-loading').style.display = 'none';
                    document.getElementById('trading-empty').style.display = 'none';
                    document.getElementById('trading-table').style.display = 'table';
                }
            } catch (error) {
                console.error('Error loading trading data:', error);
            }
        }

        // Load active bets
        function loadActiveBets(positions) {
            const tbody = document.getElementById('active-bets-tbody');
            tbody.innerHTML = '';

            if (!positions || Object.keys(positions).length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #9ca3af;">No active bets</td></tr>';
                return;
            }

            Object.entries(positions).forEach(([key, position]) => {
                const currentPrice = position.price; // TODO: fetch current price
                const pnl = (currentPrice - position.price) * position.size;
                const roi = (pnl / position.amount) * 100;
                const timeHeld = Math.floor((new Date() - new Date(position.timestamp)) / 1000 / 60); // minutes

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><small>${position.market_id ? position.market_id.substring(0, 20) + '...' : '--'}</small></td>
                    <td><span class="badge badge-${position.side.toLowerCase()}">${position.side}</span></td>
                    <td>$${position.price.toFixed(3)}</td>
                    <td>$${currentPrice.toFixed(3)}</td>
                    <td>${position.size.toFixed(2)}</td>
                    <td>${formatCurrency(position.amount)}</td>
                    <td class="${pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pnl)}</td>
                    <td class="${roi >= 0 ? 'positive' : 'negative'}">${roi.toFixed(1)}%</td>
                    <td>${timeHeld < 60 ? timeHeld + 'm' : Math.floor(timeHeld / 60) + 'h'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Connect to WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message:', data);

                // Handle different message types
                if (data.type === 'new_trade') {
                    // Refresh trades if on trades tab
                    if (document.getElementById('trades-panel').classList.contains('active')) {
                        loadTrades();
                    }
                    loadStats();
                } else if (data.type === 'paper_trade_executed') {
                    // Refresh trading if on trading tab
                    if (document.getElementById('trading-panel').classList.contains('active')) {
                        loadTradingData();
                    }
                    loadStats();
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket closed. Reconnecting in 5s...');
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                // Populate form
                document.getElementById('initial_balance').value = settings.paper_trading.initial_balance;
                document.getElementById('base_position_size_pct').value = settings.paper_trading.base_position_size_pct;
                document.getElementById('max_position_size_pct').value = settings.paper_trading.max_position_size_pct;
                document.getElementById('kelly_fraction').value = settings.paper_trading.kelly_fraction;
                document.getElementById('min_quality_score').value = settings.paper_trading.min_quality_score;

                document.getElementById('min_win_rate').value = settings.whale_filters.min_win_rate;
                document.getElementById('min_sharpe').value = settings.whale_filters.min_sharpe;
                document.getElementById('min_total_volume').value = settings.whale_filters.min_total_volume;
                document.getElementById('copy_only_mega_high').checked = settings.whale_filters.copy_only_mega_high;

                document.getElementById('stop_loss_pct').value = settings.risk_management.stop_loss_pct;
                document.getElementById('take_profit_pct').value = settings.risk_management.take_profit_pct;
                document.getElementById('max_daily_loss').value = settings.risk_management.max_daily_loss;
                document.getElementById('circuit_breaker_loss_pct').value = settings.risk_management.circuit_breaker_loss_pct;
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save settings
        async function saveSettings(event) {
            event.preventDefault();

            const newSettings = {
                paper_trading: {
                    initial_balance: parseFloat(document.getElementById('initial_balance').value),
                    base_position_size_pct: parseFloat(document.getElementById('base_position_size_pct').value),
                    max_position_size_pct: parseFloat(document.getElementById('max_position_size_pct').value),
                    kelly_fraction: parseFloat(document.getElementById('kelly_fraction').value),
                    min_quality_score: parseFloat(document.getElementById('min_quality_score').value),
                },
                whale_filters: {
                    min_win_rate: parseFloat(document.getElementById('min_win_rate').value),
                    min_sharpe: parseFloat(document.getElementById('min_sharpe').value),
                    min_total_volume: parseFloat(document.getElementById('min_total_volume').value),
                    copy_only_mega_high: document.getElementById('copy_only_mega_high').checked,
                },
                risk_management: {
                    stop_loss_pct: parseFloat(document.getElementById('stop_loss_pct').value),
                    take_profit_pct: parseFloat(document.getElementById('take_profit_pct').value),
                    max_daily_loss: parseFloat(document.getElementById('max_daily_loss').value),
                    circuit_breaker_loss_pct: parseFloat(document.getElementById('circuit_breaker_loss_pct').value),
                }
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newSettings)
                });

                const result = await response.json();

                const messageEl = document.getElementById('settings-message');
                if (result.success) {
                    messageEl.style.display = 'block';
                    messageEl.style.background = '#10b981';
                    messageEl.textContent = 'Settings saved successfully! Paper trading has been reset.';
                    await loadStats();
                    await loadTradingData();
                } else {
                    messageEl.style.display = 'block';
                    messageEl.style.background = '#ef4444';
                    messageEl.textContent = 'Failed to save settings';
                }

                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Error saving settings:', error);
                const messageEl = document.getElementById('settings-message');
                messageEl.style.display = 'block';
                messageEl.style.background = '#ef4444';
                messageEl.textContent = 'Error: ' + error.message;
            }
        }

        // Reset settings
        async function resetSettings() {
            if (!confirm('Are you sure you want to reset all settings to defaults? This will also reset your paper trading balance.')) {
                return;
            }

            try {
                const response = await fetch('/api/settings/reset', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    await loadSettings();
                    await loadStats();
                    await loadTradingData();

                    const messageEl = document.getElementById('settings-message');
                    messageEl.style.display = 'block';
                    messageEl.style.background = '#10b981';
                    messageEl.textContent = 'Settings reset to defaults!';

                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error resetting settings:', error);
            }
        }

        // Progress Bar Functions
        function updateProgress(step, percent, message) {
            // Update progress bar
            document.getElementById('backtestProgressBar').style.width = percent + '%';
            document.getElementById('backtestProgressPercent').textContent = percent + '%';
            document.getElementById('backtestProgressText').textContent = message;

            // Highlight current step
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById('step' + i);
                if (i < step) {
                    stepEl.style.color = '#10b981'; // Green for completed
                } else if (i === step) {
                    stepEl.style.color = '#667eea'; // Purple for current
                } else {
                    stepEl.style.color = '#4a5568'; // Gray for pending
                }
            }
        }

        function resetProgress() {
            updateProgress(0, 0, 'Initializing...');
        }

        // Backtesting Functions
        async function runBacktest(event) {
            event.preventDefault();

            // Get form values
            const params = {
                starting_balance: parseFloat(document.getElementById('bt_balance').value),
                max_position_usd: parseFloat(document.getElementById('bt_max_position').value),
                min_whale_quality: parseInt(document.getElementById('bt_min_quality').value),
                days_back: parseInt(document.getElementById('bt_days_back').value),
                position_size_pct: parseFloat(document.getElementById('bt_position_pct').value) / 100,
                max_daily_loss: parseFloat(document.getElementById('bt_max_daily_loss').value)
            };

            // Show loading, hide results
            document.getElementById('backtestLoading').style.display = 'block';
            document.getElementById('backtestResults').style.display = 'none';
            resetProgress();

            // Simulate progress (since backend doesn't send progress updates yet)
            updateProgress(1, 10, 'Loading historical whale trades...');

            try {
                // Small delay to show first step
                await new Promise(resolve => setTimeout(resolve, 300));
                updateProgress(1, 25, 'Fetching trade data from database...');

                const response = await fetch('/api/backtest/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });

                // Progress: Filter trades
                updateProgress(2, 40, 'Filtering trades by quality score...');
                await new Promise(resolve => setTimeout(resolve, 200));

                const result = await response.json();

                // Progress: Calculate P&L
                updateProgress(3, 65, 'Fetching market outcomes & calculating P&L...');
                await new Promise(resolve => setTimeout(resolve, 400));

                // Progress: Generate results
                updateProgress(4, 90, 'Generating performance metrics...');
                await new Promise(resolve => setTimeout(resolve, 300));

                if (result.success) {
                    updateProgress(4, 100, 'Complete!');
                    await new Promise(resolve => setTimeout(resolve, 200));
                    displayBacktestResults(result.results);
                } else {
                    alert('Backtest failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error running backtest:', error);
                alert('Error running backtest: ' + error.message);
            } finally {
                document.getElementById('backtestLoading').style.display = 'none';
            }
        }

        function displayBacktestResults(results) {
            const perf = results.performance;
            const stats = results.statistics;
            const risk = results.risk_metrics;
            const period = results.period;

            // Update performance summary
            document.getElementById('bt_start_balance').textContent = '$' + perf.starting_balance.toFixed(2);
            document.getElementById('bt_end_balance').textContent = '$' + perf.ending_balance.toFixed(2);

            const pnlValue = perf.total_pnl;
            const pnlPct = perf.total_pnl_pct;
            const pnlColor = pnlValue >= 0 ? '#10b981' : '#ef4444';
            const pnlSign = pnlValue >= 0 ? '+' : '';
            document.getElementById('bt_total_pnl').innerHTML =
                `<span style="color: ${pnlColor}">${pnlSign}$${pnlValue.toFixed(2)}</span> ` +
                `<span style="font-size: 0.9rem; color: ${pnlColor}">(${pnlSign}${pnlPct.toFixed(1)}%)</span>`;

            document.getElementById('bt_win_rate').textContent = stats.win_rate.toFixed(1) + '%';

            // Update trade statistics
            document.getElementById('bt_total_trades').textContent = stats.total_trades;
            document.getElementById('bt_winning_trades').textContent = stats.winning_trades;
            document.getElementById('bt_losing_trades').textContent = stats.losing_trades;

            // Update risk metrics
            document.getElementById('bt_max_drawdown').textContent =
                '$' + risk.max_drawdown.toFixed(2) + ' (' + risk.max_drawdown_pct.toFixed(1) + '%)';
            document.getElementById('bt_sharpe').textContent = risk.sharpe_ratio.toFixed(2);
            document.getElementById('bt_period').textContent = period.days + ' days';

            // Update all trades table
            const allTrades = results.all_trades || [];

            let tradesHTML = '<div style="max-height: 600px; overflow-y: auto; overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
            tradesHTML += '<thead style="position: sticky; top: 0; background: #1a1d35; z-index: 10;"><tr style="background: #1a1d35; color: #8b9dc3;">';
            tradesHTML += '<th style="padding: 1rem; text-align: left;">Time</th>';
            tradesHTML += '<th style="padding: 1rem; text-align: left;">Whale</th>';
            tradesHTML += '<th style="padding: 1rem; text-align: left;">Market</th>';
            tradesHTML += '<th style="padding: 1rem; text-align: center;">Side</th>';
            tradesHTML += '<th style="padding: 1rem; text-align: right;">Price</th>';
            tradesHTML += '<th style="padding: 1rem; text-align: right;">Size</th>';
            tradesHTML += '<th style="padding: 1rem; text-align: right;">P&L</th>';
            tradesHTML += '</tr></thead><tbody>';

            if (allTrades.length === 0) {
                tradesHTML += '<tr><td colspan="7" style="padding: 2rem; text-align: center; color: #8b9dc3;">No trades executed in backtest</td></tr>';
            } else {
                allTrades.forEach((trade) => {
                    const pnlColor = trade.realized_pnl >= 0 ? '#10b981' : '#ef4444';
                    const pnlSign = trade.realized_pnl >= 0 ? '+' : '';
                    const sideColor = trade.side === 'BUY' ? '#10b981' : '#ef4444';

                    const tradeTime = new Date(trade.timestamp);
                    const timeStr = tradeTime.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    tradesHTML += '<tr style="border-bottom: 1px solid #2d3352;">';
                    tradesHTML += `<td style="padding: 0.75rem; color: #8b9dc3; font-size: 0.9rem;">${timeStr}</td>`;
                    tradesHTML += `<td style="padding: 0.75rem; color: #fff;">${trade.whale_pseudonym}</td>`;
                    tradesHTML += `<td style="padding: 0.75rem; color: #8b9dc3; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${trade.market_title}">${trade.market_title}</td>`;
                    tradesHTML += `<td style="padding: 0.75rem; text-align: center; color: ${sideColor}; font-weight: bold;">${trade.side}</td>`;
                    tradesHTML += `<td style="padding: 0.75rem; text-align: right; color: #8b9dc3;">$${trade.price.toFixed(2)}</td>`;
                    tradesHTML += `<td style="padding: 0.75rem; text-align: right; color: #8b9dc3;">$${trade.position_size.toFixed(2)}</td>`;
                    tradesHTML += `<td style="padding: 0.75rem; text-align: right; color: ${pnlColor}; font-weight: bold;">${pnlSign}$${Math.abs(trade.realized_pnl).toFixed(2)}</td>`;
                    tradesHTML += '</tr>';
                });
            }

            tradesHTML += '</tbody></table></div>';
            document.getElementById('bt_all_trades').innerHTML = tradesHTML;

            // Show results
            document.getElementById('backtestResults').style.display = 'block';

            // Scroll to results
            document.getElementById('backtestResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Initialize live trading toggle
        async function initToggle() {
            const toggle = document.getElementById('live-trading-toggle');

            // Default to live trading ON
            toggle.checked = true;

            // Get current trading mode
            try {
                const response = await fetch('/api/trading/mode');
                const data = await response.json();
                // Keep toggle ON unless API explicitly says paper mode
                toggle.checked = (data.mode !== 'paper');

                // If not in live mode, set it to live
                if (data.mode !== 'live') {
                    await fetch('/api/trading/mode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: 'live' })
                    });
                }
            } catch (error) {
                console.error('Error loading trading mode:', error);
                // On error, default to checked (live mode)
                toggle.checked = true;
            }

            // Handle toggle changes
            toggle.addEventListener('change', async () => {
                const newMode = toggle.checked ? 'live' : 'paper';
                try {
                    await fetch('/api/trading/mode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: newMode })
                    });
                    console.log(`Trading mode switched to: ${newMode.toUpperCase()}`);
                } catch (error) {
                    console.error('Error updating trading mode:', error);
                    toggle.checked = !toggle.checked; // Revert on error
                }
            });
        }

        // Initialize dashboard
        async function init() {
            await loadStats();
            await loadWhales();
            connectWebSocket();

            // Initialize and start clock
            updateClock();
            setInterval(updateClock, 1000);

            // Initialize live trading toggle
            await initToggle();

            // Attach settings form handler
            document.getElementById('settings-form').addEventListener('submit', saveSettings);

            // Refresh stats every 10 seconds
            setInterval(loadStats, 10000);

            // Refresh trades every 5 seconds if on trades tab
            setInterval(() => {
                if (document.getElementById('trades-panel').classList.contains('active')) {
                    loadTrades();
                }
            }, 5000);

            // Refresh trading every 5 seconds if on trading tab
            setInterval(() => {
                if (document.getElementById('trading-panel').classList.contains('active')) {
                    loadTradingData();
                }
            }, 5000);
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
